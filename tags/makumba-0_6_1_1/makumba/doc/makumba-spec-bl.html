<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="author" content="makumba-dev group">
  <title>Makumba Specification</title>
  <link rel="stylesheet" type="text/css" media="all" href="main.css">
  <script type="text/javascript" src="main.js"></script>
</head>
<body>
<script type="text/javascript">
   makeNavBar("");
</script>
<h1>Makumba Specification</h1>

<table>
  <tr>
    <td valign="top"> <a href="makumba-spec.html" title="...writing MDDs"><b>[Data Definitions]</b></a>&nbsp; </td>
    <td valign="top"> <a href="makumba-spec-ql.html" title="...getting data from the database"><b>[Query Languages]</b></a>&nbsp; </td>
    <td valign="top"> 
      <b>[<span title="...viewing/editing data thru HTML pages">JSP tag library</span>:</b>
      <a href="makumba-spec-taglib.html" title="...controller &amp; response"><b>Intro</b></a>
      | <a href="makumba-spec-taglib-list.html" title="...viewing data thru HTML pages"><b>Listing</b></a>
      | <a href="makumba-spec-taglib-forms.html" title="...editing data thru HTML pages"><b>Forms</b></a>]
    </td>     
    <td valign="top"> <a href="makumba-spec-bl.html" title="...adding logic to basic operations"><b>[Business Logics]</b></a>&nbsp; </td>
    <td valign="top"> <a href="makumba-spec-summary.html" title="...Presentation and internal representation principles"><b>[Summary]</b></a> </td>
  </tr>
</table>

<h2><a name="Business">Business Logic (BL)</a></h2>
<table widht=100%>
<tr>
  <td valign="top">
    <div class="navbarPage">
    <ul class="navbarPage">
      <li><a href="#Attributes">Attributes</a></li>
      <br>
      <li><a href="#javahand">Java&nbsp;Handler classes</a></li>
      <br>
      <li><a href="#Login">Login, &lt;mak:login&gt;, &lt;mak:logout/&gt;</a></li>
    </ul>
    </div>
  </td>
  <td>
<h3><a name="Attributes">Attributes</a></h3>
<p>
Java Server Pages use attributes to keep the state of the application.
Makumba builds upon that its own notion of Attributes that keep the
read-only state
of a makumba task. They represent the "environment" of that makumba
task. The typical
example is a JSP page during execution, with its HTTP and session
parameters
as attributes. Since other kinds of attributes are possible, the
attribute
specification is kept HTTP-independent. Makumba BL code sees the
attributes
as an <a href="api/org/makumba/Attributes.html"><code>org.makumba.Attributes</code></a>
object.
</p>
<h3><a name="javahand">Java handler classes</a></h3>
<p> Java handler classes are classes that implement the "business
logic" of the organisation. Every makumba page will look for a handler,
and will call its methods when needed. Check also the
&lt;mak:newForm&gt; to know <a href="#handler_methods">which methods
are called</a>. <span style="font-weight: bold;">If a handler class
exists, then some operations cannot be performed if these methods are
not defined in the handler class.</span><br>
</p>
<h4>Handler Discovery</h4>
<p>
Each page will determine its handler class on first access, after being
compiled.
If the class changes on disk, a webapp reload is generally needed for
the new class to take effect.
</p>
<p>The handler is 'discovered' by decomposing the full path of the JSP
page,
and finding a class with a matching name. Decomposition breaks the full
path
at every capital letter, or forward slash.
For example, with the page path <b><code>/student/mycv/indexPersonal.jsp</code></b>,
the following criteria are applied, in order:
</p>
<table class="tagParamDef">
  <tbody>
    <tr>
      <th>criterium</th>
      <th>Java classes checked for</th>
    </tr>
    <tr>
      <td>page name</td>
      <td><tt>StudentMycvIndexPersonalLogic</tt></td>
    </tr>
    <tr>
      <td>caps parts of page/directory name</td>
      <td><tt>StudentMycvIndexLogic</tt></td>
    </tr>
    <tr>
      <td>directory name</td>
      <td><tt>StudentMycvLogic</tt></td>
    </tr>
    <tr>
      <td>parent directory name(s)</td>
      <td><tt>StudentLogic</tt> <br>
      <tt>Logic</tt></td>
    </tr>
  </tbody>
</table>
<p>
The class name prefix (e.g. java package name) can be regulated per
parts of the site in a file
called <b>MakumbaController.properties</b> which can be found in the
CLASSPATH
(just like MakumbaDatabase.properties). For example, the file can
contain:
</p>
<pre class="example">/student=org.eu.best<br>/makumba=org.makumba<br>/=test<br></pre>
<p>
</p>
<table class="tagParamDef">
  <tbody>
    <tr>
      <th>path</th>
      <th>Java classes checked for</th>
    </tr>
    <tr>
      <td><tt>/student/mycv/index.jsp</tt></td>
      <td><tt>org.eu.best.MycvIndexLogic</tt> <br>
      <tt>org.eu.best.MycvLogic</tt> <br>
      <tt>org.eu.best.Logic</tt></td>
    </tr>
    <tr>
      <td><tt>/makumba/tests/x.jsp</tt></td>
      <td><tt>org.makumba.TestsXLogic</tt> <br>
      <tt>org.makumba.TestsLogic</tt> <br>
      <tt>org.makumba.Logic</tt></td>
    </tr>
    <tr>
      <td><tt>/some.jsp</tt></td>
      <td><tt>test.SomeLogic</tt> <br>
      <tt>test.Logic</tt></td>
    </tr>
  </tbody>
</table>
<p class="futfeat">There are good reasons to take into account the
name of the response page of a form when looking for the business
logic.
Still, <span style="font-weight: bold;">it is the name of the page
that contains the form which matters</span> <span
 style="font-style: italic;">not </span>the name of the action page.
It is good practice for both pages to actually have the same handler
class.
</p>
<p>
All methods of the handlers are http-independent.
Methods are non-static, so the handler classes can use inheritance to
their advantage.
Still, handler classes are singletons (only one instance of a certain
class in a JVM).
For example, the validation of a form can be in a class that is closer
to the actual JSP
application (view level) while the more view-independent methods can be
in the parent of that class. For example:
</p>
<pre class="example">org.eu.best.minerva.StudentHandler extends org.eu.best.StudentHandler<br></pre>
<h4>Role of Java handlers</h4>
<ol>
  <li><b>find attributes</b> unknown by pages. e.g.
    <pre class="example">&lt;mak:object from="best.Student stud" where="stud=$student"&gt; ...&lt;/mak:object&gt;<br></pre>
    <p>If the <code>$student</code> attribute is not known in the
page (from a http argument) or in the session, the <code>find{AttributeName}(Dictionary
existingAttributes, Database d, String expression)</code> method is
called for
the Handler object. In this case findStudent(). The handler has to
compute
the attribute, based on existing attributes, making DB accesses. </p>
    <div class="note">The find{AttributeName} method's name is
constructed literally from the
name of the
attribute (capitalising only the first letter),
so dots and other illegal characters for java identifier names, are not
to be used. Also, one shouldn't use 2 attribute names that differ only
in the capitalisation of the first letter. </div>
    <p>For example "<code>lbg.$lbg_order</code>" (in an example
elsewhere in
the specs),
will generate a call <code>findLbg_order(otherAttributes, db)</code>
and the Java handler will return the default
ordering for LBGs (say "name"). </p>
    <p>If the attribute is computed successfully, it
is associated with the session (i.e. set as JSP attribute in session
scope) </p>
    <p>If not, an exception will be thrown (typically <a
 href="api/org/makumba/UnauthenticatedException.html"><code>org.makumba.UnauthenticatedException</code></a>),
and the engine will act accordingly (i.e. ask for authentication). </p>
  </li>
  <li><b>execute action methods</b> in response to makumba
forms. See <a href="#forms">makumba forms and actions</a> below.
    <p> </p>
  </li>
  <li class="futfeat">( later: return query parts, as methods. e.g. <code>&lt;mak:value
expr="lbg.$title()" /&gt;</code> will generate a call to method <code>BestInternalLbgTitle(lbg)</code>
which can return an OQL expression "<code>concat(lbg.id, \"-\" lbg.name)</code>"
(such methods can be put directly in the Makumba data definitions) For
now, OQL only accepts count() and sum(), but that can be easily fixed,
till then, the method can be replaced by hand: <code>&lt;mak:value
expr="lbg.id"/&gt;-&lt;mak:value expr="lbg.name"/&gt;</code> )</li>
</ol>
<h4>Handler Initialization</h4>
<p>
Whenever a handler is used in a new context (i.e.
with a different set of attributes, e.g. a new page access), a method
called
<code>checkAttributes(Attributes a, Database db)</code> is looked for
and executed,
if it is defined.
</p>
<p><b><code>checkAttributes</code></b> can perform sanity checks
for attributes used in the respective logic (in case of mismatches,
<a href="api/org/makumba/UnauthorizedException.html"><code>org.makumba.UnauthorizedException</code></a>
is usually thrown), can load attributes that are absolutely needed for
page execution
(<span class="oldfeat">formerly given by the requiredAttributes()
method</span>), etc.
</p>
<h3><a name="Login">Login</a></h3>
Login is done as a result of a missing attribute
(possibly invoked in <b><code>checkAttributes</code></b>), when a <code>find{AttributeName}</code>
method is
called. The missing attribute is the principal that needs to log in.
<p>If the attribute cannot be found due to wrong login information,
<a href="api/org/makumba/UnauthenticatedException.html"><code>org.makumba.UnauthenticatedException</code></a>
is usually thrown.
</p>
<p> The principal (the person who logs in) can have more members (e.g.
group, Lbg, Company representatives). E.g. the findCompany() method
will check to see if the authentication (email_address and password)
corresponds to any company representative of that company. If yes, it
will return that company. </p>
<p class="futfeat">Login can be done in 2 ways:</p>
<ol>
  <li class="futfeat"> (Http basic authentication login: will set the
attributes $username, $password )</li>
  <li>cookie login: done in a page called <code>login.jsp</code>,
in the same directory or (if missing) in any of the parents.
It should contain at least:
    <pre class="example">&lt;mak:login&gt;<br>  &lt;input type=text name=username&gt;<br>  &lt;input type=password name=password&gt;<br>  &lt;input type=submit&gt;<br>&lt;/mak:login&gt;<br></pre>
    <p>The login form will pass further (as hidden arguments)
all the http parameters it got. Note that <code>&lt;mak:login&gt;</code>
is only needed
upon automatic login (a page displayed when the user requested another
page, that needs authentication). If you wish to ask for login manually
in a startup page, a normal HTML form is enough. </p>
  </li>
</ol>
<p>
To cancel out a certain attribute, in order to produce a new login,
the logout tag is available
</p>
<pre class="example">&lt;mak:logout actor="student"/&gt;<br></pre>
<p> You can remove (cancel-out, logout) multiple attributes from the
session by using <code>&lt;mak:logout actor="attribute name"&gt;</code>
several times and/or by using the star (*) wildcard, e.g.: </p>
<pre class="example">&lt;mak:logout actor="demo_*"/&gt; (attributes whose names start with "demo_")<br>&lt;mak:logout actor="*app"/&gt; (attributes whose names end with "app")<br>&lt;mak:logout actor="*"/&gt; (all attributes; this "invalidates" the session)<br></pre>
<p>
</p>
<div class="futfeat"> (Later on, logout request might be done in the
business logic, with a method <code>deleteAttributes(param)</code>
that can accept either a String (with optional '*') or a String[]. )
<p>(Later: to accomodate servers that don't do session tracking, login
can be done by a query condition rather than by doing a query (once per
session) to find an attribute. This way, it won't need to do a query
(to check the authentication) at every access, but that condition will
make sure that authentication is done. ) </p>
<p><tt>(&lt;mak:object from="best.Student stud" where
="stud.$login()"&gt; ...&lt;/mak:object&gt;</tt> <br>
then methodBestSudentLogin("stud") will return
"stud.auth.email=$username AND stud.auth.password=$password"
<br>
This can be used for http authentication with no session tracking. ) </p>
<p>(Later: if an attribute has multiple values, a <code>choose{AttributeName}.jsp</code>
page is shown. For example, a super user (for that area) can choose to
act as any student, Lbg, or company... A student member of more local
Vivaldi teams can choose to act for any of the viv teams, etc. )</p>
</div>

  </td>
</tr>
</table>

<script type="text/javascript">
   makeFooter("$Id$");
</script>
</body>
</html>
