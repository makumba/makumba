var WikiSnippets={getSnippets:function(){var C=new Date();var B=((C.getDate()<10)?"0"+C.getDate():C.getDate());var D=((C.getMonth()<9)?"0"+(C.getMonth()+1):(C.getMonth()+1));var A=C.getFullYear()+"-"+D+"-"+B;return{toc:{snippet:["","[{TableOfContents }]","\n"],tab:["[{TableOfContents }]",""]},link:{snippet:["[","link text|pagename","]"],tab:["link text","pagename",""]},code:{snippet:["%%prettify \n{{{\n","some code block","\n}}}\n/%\n"],tab:["some code block",""]},pre:{snippet:["{{{\n","some preformatted block","\n}}}\n"],tab:["some preformatted block",""]},br:{snippet:["\\\\\n","",""],tab:[""]},bold:{snippet:["__","some bold text","__"],tab:["some bold text",""]},italic:{snippet:["''","some italic text","''"],tab:["some italic text",""]},h1:{snippet:["!!!","Heading 1 title\n",""],tab:["Heading 1 title\n",""]},h2:{snippet:["!!","Heading 2 title",""],tab:["Heading 2 title\n",""]},h3:{snippet:["!","Heading 3 title",""],tab:["Heading 3 title\n",""]},dl:{snippet:[";","term:definition text",""],tab:["term","definition text",""]},mono:{snippet:["{{","some monospaced text","}}"],tab:["some monospaced text",""]},hr:{snippet:["","----","\n"],tab:[""]},sub:{snippet:["%%sub ","subscript text","/%"],tab:["subscript text",""]},sup:{snippet:["%%sup ","superscript text","/%"],tab:["superscript text",""]},strike:{snippet:["%%strike ","strikethrough text","/%"],tab:["strikethrough text",""]},tab:{snippet:["%%tabbedSection \n","%%tab-tabTitle1\ntab content 1\n/%\n%%tab-tabTitle2\ntab content 2","\n/%\n/%\n"],tab:["tabTitle1","tab content 1","tabTitle2","tab content 2",""]},table:{snippet:["\n","||heading 1||heading 2\n| cell 1   | cell 2","\n"],tab:["heading 1","heading 2","cell 1","cell 2",""]},img:{snippet:["","[{Image src='img.jpg' width='..' height='..' align='left|center|right' style='..' class='..' }]","\n"],tab:["img.jpg",""]},quote:{snippet:["%%quote \n","quoted text","\n/%\n"],tab:["quoted text",""]},"%%":{snippet:["%%","wikistyle\nsome text","\n/%"],tab:["wikistyle","some text",""]},sign:{snippet:["\\\\\n--",Wiki.UserName+", "+A,"\n"],tab:[Wiki.UserName,A,""]},date:{command:function(E){var J=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],G=["January","February","March","April","May","June","July","August","September","October","November","December"],H=new Date(),I=H.getYear();if(I<1000){I+=1900}var F=J[H.getDay()]+", "+G[H.getMonth()]+" "+H.getDate()+", "+I;return{snippet:["",F," "],tab:[F,""]}}}}},getSmartPairs:function(){return{'"':'"',"(":")","{":"}","[":"]","<":">","'":{scope:{"{{{":"}}}"},pair:"'"}}}};var EditTools={onPageLoad:function(){Wiki.onPageLoad();window.onbeforeunload=(function(){var A=$("editorarea");if(A.value!=A.defaultValue){return"edit.areyousure".localize()}}).bind(this);this.wikisnippets=WikiSnippets.getSnippets();this.wikismartpairs=WikiSnippets.getSmartPairs();this.mainarea=this.textarea=$("editorarea");if(!this.textarea||!this.textarea.visible){return }this.onPageLoadSectionEdit();this.ta=TextArea.initialize(this.textarea);this.onPageLoadResizeTextarea();this.onPageLoadToolbar();this.onPageLoadPostEditor();this.onPageLoadPreview();this.textarea.addEvent("click",this.getSuggestions.bind(this)).addEvent("keyup",this.getSuggestions.bind(this)).addEvent("change",this.onChangeTextarea.bind(this)).focus();this.textarea.fireEvent.periodical(3000,this.textarea,["change"])},onPageLoadResizeTextarea:function(){var A=Wiki.prefs.get("EditorSize");if(A){this.textarea.setStyle("height",A)}var B=new Element("div",{"class":"textarea-resizer",title:"edit.resize".localize()}).injectAfter(this.textarea);this.textarea.makeResizable({handle:B,modifiers:{x:false,y:"height"},onComplete:function(){Wiki.prefs.set("EditorSize",this.value.now.y)}})},onPageLoadToolbar:function(){$("tools").addClass("collapsebox-closed");Collapsible.render("editform","");$("tbREDO").addEvent("click",this.redo.bind(this));$("tbUNDO").addEvent("click",this.undo.bind(this));$("doreplace").addEvent("click",this.doReplace.bind(this));$$("#tools a.tool").addEvent("click",this.toggleSnippet.bind(this))},doReplace:function(E){new Event(E).stop();var G=$("tbFIND").value,B=$("tbREPLACE").value,C=$("tbREGEXP").checked,F=$("tbGLOBAL").checked?"g":"",I=$("tbMatchCASE").checked?"":"i";if(G==""){return }var A=TextArea.getSelection(this.textarea),D=(!A||(A==""))?this.textarea.value:A;if(!C){var H=new RegExp("([.*\\?+[^$])","gi");G=G.replace(H,"\\$1")}var H=new RegExp(G,F+I+"m");if(!H.exec(D)){Wiki.alert("edit.findandreplace.nomatch".localize());return }D=D.replace(H,B);this.store();if(!A||(A=="")){this.textarea.value=D}else{TextArea.replaceSelection(this.textarea,D)}this.textarea.fireEvent("change")},onPageLoadPostEditor:function(){if(window.ie){return }$("toolextra").show();this.posteditor=new postEditor.create(this.textarea,"changenote");this.posteditor.onKeyRight=Class.empty;this.posteditor.value=function(A){EditTools.store();this.element.value=A.join("");this.element.fireEvent("change")};this.posteditor.onBackspace=function(D){var B=this.ss(),C=this.se();if(B==C&&this.slice(B-this.tabl,B)==this.tab){return }else{if(B==C){var A=this.slice(B-1,B),F=this.slice(B,B+1),E=this.options.smartTypingPairs[A];if($type(E)=="string"){E={pair:E}}if(E&&E.pair==F){this.value([this.getStart(E.pair),this.slice(B,this.element.value.length)]);this.selectRange(B,0)}}}};if(window.webkit){this.textarea.addEvent("keydown",function(A){if(A.keyCode==9){EditTools.posteditor.onKeyPress(A)}})}["smartpairs","tabcompletion"].each(function(A){$(A).setProperty("checked",Wiki.prefs.get(A)||false).addEvent("click",function(B){Wiki.prefs.set(A,this.checked);EditTools.initPostEditor()})},this);this.initPostEditor()},initPostEditor:function(){if(!this.posteditor){return }this.posteditor.changeSmartTypingPairs($("smartpairs").checked?this.wikismartpairs:{});this.posteditor.changeSnippets($("tabcompletion").checked?this.wikisnippets:{})},toggleSnippet:function(G){G=new Event(G).stop();var C=G.target,F=this.wikisnippets[C.getText()];if(!F){return }var B=TextArea.getSelection(this.textarea),E=F.snippet[0],D=F.snippet[2],A=F.snippet.join("");this.store();if((C.rel=="break")&&(!TextArea.isSelectionAtStartOfLine(this.textarea))){A="\n"+A}if(B){if((B.indexOf(E)==0)&&(B.lastIndexOf(D)==(B.length-D.length))){A=B.substring(E.length,B.length-D.length)}else{A=A.replace(F.tab[0],B)}}TextArea.replaceSelection(this.textarea,A)},$undo:[],$redo:[],$maxundo:20,$get:function(){var A=this.textarea,B=TextArea.getSelectionCoordinates(A);return{main:this.mainarea.value,value:A.value,cursor:B,scrollTop:A.scrollTop,scrollLeft:A.scrollLeft}},$put:function(B){var A=this.textarea;this.mainarea.value=B.main;A.value=B.value;A.scrollTop=B.scrollTop;A.scrollLeft=B.scrollLeft;TextArea.setSelection(B.cursor.start,B.cursor.end);A.fireEvent("change")},store:function(){this.$undo.push(this.$get());this.$redo=[];if(this.$undo.length>this.$maxundo){this.$undo.shift()}$("tbUNDO").disabled="";$("tbREDO").disabled="true"},undo:function(A){new Event(A).stop();if(this.$undo.length>0){$("tbREDO").disabled="";this.$redo.push(this.$get());this.$put(this.$undo.pop())}else{$("tbUNDO").disabled="true"}},redo:function(A){new Event(A).stop();if(this.$redo.length>0){this.$undo.push(this.$get());this.$put(this.$redo.pop());$("tbUNDO").disabled=""}else{$("tbREDO").disabled="true"}},getSuggestions:function(){var H=this.textarea,A=TextArea.getSelectionCoordinates(H),B=H.value,G="",I=0;var D="findSuggestionMenu",F=$(D)||new Element("div",{id:D}).injectAfter($("favorites").getFirst());for(var E=A.start-1;E>=0;E--){if(B.charAt(E)=="]"){break}if(B.charAt(E)=="["&&E<B.length-1){G=B.substring(E+1,A.start);if(G.charAt(0)=="{"){return }if(G.indexOf("|")!=-1){G=G.split("|")[1]}I=G.length;if(I==0){G=Wiki.PageName+"/"}break}}if(G==""){return F.hide()}if(A.start==A.end){var J=B.substring(A.start),C=J.search(/[\n\r\]]/);if(C!=-1){A.end=A.start+C}}Wiki.jsonrpc("search.getSuggestions",[G,30],function(K,M){if(M){alert(M.message)}else{if(!K.list||(K.list.length==0)){F.hide()}else{var L=new Element("ul").inject(F.empty().show());K.list.each(function(N){new Element("li",{title:N,events:{click:function(O){new Event(O).stop();EditTools.store();TextArea.setSelection(A.start,A.end);TextArea.replaceSelection(H,N.substr(I));A.end=A.start+N.length-I},mouseout:function(){this.removeClass("hover")},mouseover:function(){this.addClass("hover")}}}).setHTML(N.trunc(36)).inject(L)})}}})},onPageLoadPreview:function(){var A=$("autopreview");if(!A){return }A.setProperty("checked",Wiki.prefs.get("autopreview")||false).addEvent("click",function(){var B=this.textarea,C=A.checked;$("sneakpreview").empty();B.removeEvents("preview");Wiki.prefs.set("autopreview",C);if(C){B.addEvent("preview",this.refreshPreview.bind(this)).fireEvent("preview")}}.bind(this)).fireEvent("click")},refreshPreview:function(){var A=$("sneakpreview");$("previewSpin").show();new Ajax(Wiki.TemplateUrl+"/AJAXPreview.jsp?page="+Wiki.PageName,{postBody:"wikimarkup="+encodeURIComponent(this.textarea.value),update:A,onComplete:function(){$("previewSpin").hide();Wiki.renderPage(A,Wiki.PageName)}}).request()},onPageLoadSectionEdit:function(){if((Wiki.Context!="edit")||(Wiki.prefs.get("SectionEditing")!="on")){return }this.textarea=this.mainarea.clone().removeProperty("id").removeProperty("name").injectBefore(this.mainarea.hide());var A=new Element("div",{id:"toctoc"}).adopt(new Element("label").setHTML("sectionediting.label".localize()),this.sections=new Element("ul")).injectTop($("favorites"));this.onSectionLoad();var B=location.search.match(/[&?]section=(\d+)/);B=(B&&B[1])?1+B[1].toInt():0;if((B>0)&&this.textarea.sop){B++}this.onChangeSection(B)},onSectionLoad:function(){var G=this.mainarea.value,E=this.textarea,J="\u00a4";G=G.replace(/\{\{\{([\s\S]*?)\}\}\}/g,function(K){return K.replace(/^!/mg," ")});var F=G.replace(/^([!]{1,3})/mg,J+"$1"+J).split(J);this.newSection();E.sop=(F.length>1)&&(F[0]!="");if(E.sop){this.addSection("edit.startOfPage".localize(),0,0)}var H=F.shift().length,B=F.map(function(K){return K.length});for(var D=0;D<B.length;D=D+2){var C=B[D],A=(C==2)?1:(C==1)?2:0,I=F[D+1].match(/.*?$/m)[0];this.addSection(I,H,A);H+=C+B[D+1]}},setSection:function(B){var A=this.sections.getChildren();if(B<0||B>=A.length){B=0}A.removeClass("cursor");A[B].addClass("cursor")},newSection:function(){this.sections.empty();this.sections.offsets=[];this.addSection("edit.allsections".localize(),-1,0)},addSection:function(C,B,A){C=C.replace(/~([^~])/g,"$1");this.sections.offsets.push(B);this.sections.adopt(new Element("li").adopt(new Element("a",{"class":"action",styles:{"padding-left":(A+0.5)+"em"},title:C,events:{click:this.onChangeSection.pass([this.sections.offsets.length-1],this)}}).setHTML(C.trunc(30))))},onChangeSection:function(C){var B=this.sections.offsets,A=this.textarea,D=this.mainarea.value;this.setSection(C);A.cursor=C;A.begin=(C==0)?0:B[C];A.end=((C==0)||(C+1>=B.length))?D.length:B[C+1];A.value=D.substring(A.begin,A.end);A.focus();A.fireEvent("preview")},onChangeTextarea:function(){var A=this.textarea,D=this.mainarea;if(A.value==this.cacheTextarea){return }this.cacheTextarea=A.value;if(this.sections){var C=D.value,B=((A.value.slice(-1)!="\n")&&(C.charAt(A.end)=="!"))?"\n":"";D.value=C.substring(0,A.begin)+A.value+B+C.substring(A.end);A.end=A.begin+A.value.length;this.onSectionLoad()}A.fireEvent("preview")}};var TextArea={initialize:function(A){this.textarea=$(A);return this},getSelection:function(C){var A=$(C);if(!A){return""}var B=this.getSelectionCoordinates(C);return A.getValue().substring(B.start,B.end)},setSelection:function(D,A){var C=this.textarea;if(window.ie){var B=C.createTextRange();B.collapse(true);B.moveStart("character",D);B.moveEnd("character",A-D);B.select()}else{C.selectionStart=D;C.selectionEnd=A}},getCursor:function(A){return this.getSelectionCoordinates(A).start},getSelectionCoordinates:function(D){var C=$(D);if(!C){return""}if(window.ie){var B=document.selection.createRange(),A=B.duplicate();A.moveToElementText(C);A.setEndPoint("EndToEnd",B);return{start:A.text.length-B.text.length,end:A.text.length}}else{if(C.selectionStart||C.selectionStart=="0"){return{start:C.selectionStart,end:C.selectionEnd}}else{return{start:C.value.length,end:C.value.length}}}},replaceSelection:function(G,D){var C=$(G);if(!C){return }var E=C.scrollTop;if(window.ie){C.focus();var B=document.selection.createRange();B.text=D;B.collapse(true);B.moveStart("character",-D.length);B.select()}else{var F=C.selectionStart,A=C.selectionEnd;C.value=C.value.substring(0,F)+D+C.value.substring(A);C.selectionStart=F;C.selectionEnd=F+D.length}C.focus();C.scrollTop=E;C.fireEvent("change")},isSelectionAtStartOfLine:function(C){var B=$(C);if(!B){return false}var A=this.getCursor(C);return((A<=0)||(B.value.charAt(A-1).match(/[\n\r]/)))}};window.addEvent("load",EditTools.onPageLoad.bind(EditTools));